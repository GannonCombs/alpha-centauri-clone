================================================================================
AI GARRISONING SYSTEM - DESIGN PLAN
================================================================================

OVERVIEW
--------
Implement intelligent base garrisoning for AI that balances defensive needs
with offensive operations. AI should protect vulnerable bases without
sacrificing strategic initiative.

CURRENT AI BEHAVIOR (ai.py)
----------------------------
- Colony pods: Seek founding locations, found bases when suitable
- Military units: 60% pursue player targets, 40% explore randomly
- Combat: Calculated odds-based decisions (weapon vs armor + health)
- NO garrison logic currently implemented

DESIGN GOALS
------------
1. Defend vulnerable (empty) bases
2. Maintain offensive pressure on player
3. Avoid over-committing to defense
4. Natural unit flow toward undefended bases
5. Distance-aware priority system

GARRISONING ALGORITHM
---------------------

PRIORITY TIERS (based on distance to ungarrisoned base):
- CRITICAL (1-2 tiles): Strong preference for garrisoning
- MODERATE (3-4 tiles): 50% chance to garrison
- LOW (5+ tiles): Ignore, continue mission

DECISION HIERARCHY (for military units):
1. IMMEDIATE COMBAT: Adjacent enemy + favorable odds → Attack
2. CRITICAL DEFENSE: Ungarrisoned base 1-2 tiles away → Move to garrison
3. OFFENSIVE PURSUIT: Player target visible + good odds → Pursue (60% chance)
4. MODERATE DEFENSE: Ungarrisoned base 3-4 tiles away → Garrison (50% chance)
5. EXPLORATION: Move randomly

IMPLEMENTATION DETAILS
----------------------

NEW METHODS TO ADD:

1. _find_nearest_ungarrisoned_base(unit, game)
   - Searches AI-owned bases without garrison
   - Returns (base_x, base_y, distance) or None
   - Uses existing _distance() method with wrapping

2. _should_garrison(unit, base_distance, game)
   - Evaluates whether to prioritize garrison
   - Distance-based decision:
     * distance <= 2: Always return True (CRITICAL)
     * distance 3-4: 50% probability (MODERATE)
     * distance >= 5: Always return False (LOW)
   - Exception: Damaged units (< 75% health) prefer garrison at any distance

3. MODIFY _move_military_unit(unit, game)
   Current flow:
   - Check adjacent enemies → attack if favorable
   - Find player targets → pursue (60%) or explore (40%)

   New flow:
   - Check adjacent enemies → attack if favorable (UNCHANGED)
   - Check ungarrisoned bases → evaluate garrison priority
   - If should garrison → move toward base
   - Else continue with pursuit/exploration (UNCHANGED)

SPECIAL CASES
-------------
- Damaged units (< 75% HP): Prefer garrisoning over combat
- Multiple empty bases: Choose nearest
- Base becomes garrisoned while moving: Unit continues to destination
  (will arrive and join garrison, multiple defenders OK)
- Colony pods: NEVER garrison (they found bases instead)

BALANCE CONSIDERATIONS
----------------------
- Most units continue offensive operations (5+ tiles from bases)
- Only nearby units (1-4 tiles) consider defensive duty
- Probabilistic (50% at moderate range) prevents all units rushing same base
- Damaged units naturally retreat to safety
- Critical range (1-2 tiles) ensures bases get defenders quickly

EXPECTED GAMEPLAY IMPACT
------------------------
- AI bases rarely left completely undefended
- AI maintains offensive pressure while defending
- Wounded units retreat to bases (realistic behavior)
- Player must overcome garrisons to capture bases
- More tactical depth in AI decision-making

CODE CHANGES REQUIRED
---------------------
File: ai.py

1. Add _find_nearest_ungarrisoned_base() after line 267
2. Add _should_garrison() after _find_nearest_ungarrisoned_base()
3. Modify _move_military_unit() (lines 62-106)
   - Add garrison check after adjacent combat check
   - Add garrison movement before pursuit logic

TESTING CHECKLIST
-----------------
[ ] AI garrisons bases within 1-2 tiles
[ ] AI doesn't abandon offense for distant bases
[ ] Damaged AI units retreat to bases
[ ] Multiple AI units can garrison same base
[ ] AI still attacks player units when favorable
[ ] Colony pods unaffected (still found bases)

================================================================================
