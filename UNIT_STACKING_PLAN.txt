================================================================================
UNIT STACKING SYSTEM - IMPLEMENTATION PLAN
================================================================================

PROBLEM
-------
Units cannot stack on the same tile. When a base finishes production and a unit
is already present, the new unit spawns in an adjacent tile (or fails to spawn).
This is incorrect behavior - units should be able to stack, especially when
produced at bases.

REQUIREMENTS
------------
1. Allow multiple units to occupy the same tile
2. Visually show only one unit at a time on the map
3. W key cycles through units at selected tile (moves icon up when cycling)
4. New unit stack panel at bottom of UI showing all units in a stack
   - ~8 icons wide
   - Left/right arrows to scroll if more than 8 units
5. Resize UI: Make map shorter, console taller (280px instead of 200px)
6. Unit stack panel positioned under battle panel, ~1/3 console width

COMPLETED CHANGES
-----------------
✓ map.py: Changed Tile.unit → Tile.units (list)
✓ map.py: Added Tile.displayed_unit_index for W key cycling
✓ map.py: Added helper methods:
  - add_unit_at(x, y, unit)
  - remove_unit_at(x, y, unit)
  - clear_units_at(x, y)
  - cycle_displayed_unit(x, y)
  - get_unit_at() now returns displayed unit from stack
✓ constants.py: Increased UI_PANEL_HEIGHT from 200 to 280

REMAINING CHANGES NEEDED
------------------------

1. GAME.PY - Update all tile.unit references
   ==========================================

   Line 248: if target_tile.unit and target_tile.unit != unit:
   → Change to: if target_tile.units and len(target_tile.units) > 0:
   → Check if any unit in stack is enemy (for combat)
   → Check if all units in stack are friendly (for movement blocking)

   Line 250: if target_tile.unit.owner != unit.owner:
   → Need to iterate through units to find enemies

   Line 256: 'defender': target_tile.unit,
   → Select top unit from stack as defender

   Line 263: self.resolve_combat(unit, target_tile.unit, target_x, target_y)
   → Use top unit from stack

   Line 272: old_tile.unit = None
   → Change to: self.game_map.remove_unit_at(unit.x, unit.y, unit)

   Line 280: target_tile.unit = unit
   → Change to: self.game_map.add_unit_at(target_x, target_y, unit)

   Line 505-506: if tile and tile.unit == unit: tile.unit = None
   → Change to: self.game_map.remove_unit_at(unit.x, unit.y, unit)

   Line 573: tile.unit = None
   → Change to: self.game_map.clear_units_at(unit.x, unit.y)

   Line 617: if tile and tile.unit is None:
   → Change to: if tile: (always allow spawning at base, units can stack)

   Line 635: if adj_tile and adj_tile.unit is None:
   → Can probably remove this check or make it smarter

2. AI.PY - Update tile.unit references
   ====================================

   Search for: if check_tile.unit
   → Change to: if len(check_tile.units) > 0

   Search for: if target_tile.unit and target_tile.unit.owner != unit.owner
   → Update to check units list

3. RENDERER.PY - Update unit rendering
   ====================================

   Search for how units are drawn on map
   → Should call game_map.get_unit_at() which already returns displayed unit
   → Add visual indicator when cycling (icon moved up slightly)

4. MAIN.PY - Add W key handler
   ===========================

   In input handling section:
   - Check for K_w key press
   - If unit selected, call game_map.cycle_displayed_unit(unit.x, unit.y)
   - Update selected_unit to newly displayed unit

5. UI/UI_MANAGER.PY - Add unit stack panel
   ========================================

   Create new panel under battle panel:
   - Position: Below battle_ui panel (around x=680, y=varies)
   - Width: ~120 pixels (1/3 of battle panel width 360)
   - Height: ~70 pixels
   - Show up to 8 unit icons (mini circles)
   - Left/right scroll arrows if > 8 units
   - Display units from currently selected tile
   - Update when:
     * Different tile selected
     * Unit moves
     * Unit created/destroyed
     * W key cycles units

6. UI/BATTLE_UI.PY - Adjust panel positioning
   ==========================================

   Battle panel currently at y = UI_PANEL_Y + 10
   Make room for unit stack panel below it

   Current battle panel: 360px wide, full height
   New: Keep width, reduce height to make room for stack panel

TECHNICAL CONSIDERATIONS
-------------------------

COMBAT WITH STACKED UNITS:
- When attacking a tile with multiple units, fight top unit first
- After battle, if defender destroyed, next unit in stack becomes visible
- Attacker cannot move onto tile if enemy units remain

MOVEMENT WITH STACKING:
- Friendly units can always stack together
- Moving onto friendly unit adds to stack
- Cannot move onto enemy stack (must attack instead)

GARRISON VS STACKING:
- Garrison is separate from stacking (base.garrison list)
- Units in garrison are also in tile.units
- When unit enters base, add to both garrison and stack
- When unit leaves base, remove from both

SELECTION LOGIC:
- Click on tile: Select top unit (displayed_unit_index)
- W key: Cycle through units, select each in turn
- Selected unit shown with yellow border

VISUAL INDICATORS:
- Normal: Unit centered on tile
- Cycling: Unit moved up slightly (y offset -5px)
- Stack count: Small number in corner showing "3/5" (unit 3 of 5)

IMPLEMENTATION ORDER
--------------------
1. Update game.py unit movement logic (critical)
2. Update ai.py unit detection logic
3. Test basic stacking works
4. Add W key cycling in main.py
5. Update renderer to show visual indicators
6. Add unit stack panel to UI
7. Test all features together

TESTING CHECKLIST
-----------------
[ ] Units can stack at bases
[ ] Production spawns units at base even if occupied
[ ] Units can stack anywhere on map (friendly only)
[ ] W key cycles through stacked units
[ ] Combat works with stacked units
[ ] AI detects stacked enemy units
[ ] Unit stack panel shows correct units
[ ] Scroll arrows work when > 8 units
[ ] Selection works correctly with stacks
[ ] Movement to/from stacks works
[ ] Garrison still works with stacking

FILE MODIFICATION SUMMARY
--------------------------
✓ map.py - DONE
✓ constants.py - DONE
⚠ game.py - MAJOR UPDATES NEEDED
⚠ ai.py - UPDATES NEEDED
⚠ renderer.py - UPDATES NEEDED
⚠ main.py - W KEY HANDLER NEEDED
⚠ ui/ui_manager.py - STACK PANEL NEEDED
⚠ ui/battle_ui.py - POSITIONING ADJUSTMENT NEEDED

ESTIMATED SCOPE
---------------
- 15-20 locations in game.py need updates
- 3-5 locations in ai.py need updates
- 2-3 renderer changes
- 1 new input handler in main.py
- 1 new UI panel component (~100-150 lines)
- Total: ~200-300 lines of code changes/additions

================================================================================
